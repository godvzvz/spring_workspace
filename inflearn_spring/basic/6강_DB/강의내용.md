# 강의 내용
- DB 설정

1. H2 설치
  - H2 : 개발이나 테스트 용도로 가볍고 편리한 DB, 웹 화면 제공

  - 테이블 생성
    ``` sql
    drop table if exists member CASCADE;
    create table member
    (
    id bigint generated by default as identity,
    name varchar(255),
    primary key (id)
    );
    ```

2. 순수 Jdbc

    1) build.gradle 에 dependency 추가
    ``` html
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    runtimeOnly 'com.h2database:h2'
      ```

    2) resources/application.properties 파일 설정

    ``` html
    spring.datasource.url=jdbc:h2:tcp://localhost/~/test
    spring.datasource.driver-class-name=org.h2.Driver
    spring.datasource.username=sa
    ```

    - jdbc를 직접 관리하는 코드
    - SQL문을 관리

    ``` java
    public class JdbcMemberRepository implements MemberRepository {
      private final DataSource dataSource;
      public JdbcMemberRepository(DataSource dataSource) {
        this.dataSource = dataSource;
      }
      @Override
      public Member save(Member member) {
        String sql = "insert into member(name) values(?)";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
      try {
        conn = getConnection();
        pstmt = conn.prepareStatement(sql,
        Statement.RETURN_GENERATED_KEYS);
        pstmt.setString(1, member.getName());
        pstmt.executeUpdate();
        rs = pstmt.getGeneratedKeys();
      if (rs.next()) {
        member.setId(rs.getLong(1));
      } else {
        throw new SQLException("id 조회 실패");
      }
        return member;
      } catch (Exception e) {
        throw new IllegalStateException(e);
      } finally {
        close(conn, pstmt, rs);
      }
    }
    ```
    - DataSource는 데이터베이스 커넥션을 획들할 때 사용하는 객체
      * 스프링 부트는 데이터베이스 커넥션 정보를 바탕으로 DataSource를 생성하고 스프링 빈으로 만들어준다
    - 데이터 소스를 교체하는 것처럼 미정인 부분/수정되는 부분 교체를 클래스 변경함으로써 손쉽게 변경 가능
      * Configuration의 빈 DI 부분을 확인해보자
        - 아직까진 DI 말곤 java 특성 느낌 아닌가?
      * 개방-폐쇄 원칙(OCP, Open-Closed Principle)
        * 확장에는 열려있고, 수정, 변경에는 닫혀있다.


    ![](JDBC.png)

2. 스프링 JdbcTemplate
  - Jdbc를 통합해서 만든 클래스 느낌?
  - 반복되는 코드 부분을 제거해준다.
  - 하지만 SQL은 직접 작성해야 한다.
  ``` java
  public class JdbcTemplateMemberRepository implements MemberRepository {
    private final JdbcTemplate jdbcTemplate;
    public JdbcTemplateMemberRepository(DataSource dataSource) {
    jdbcTemplate = new JdbcTemplate(dataSource);
    }
    @Override
    public Member save(Member member) {
    SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
    jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
    Map<String, Object> parameters = new HashMap<>();
    parameters.put("name", member.getName());
    Number key = jdbcInsert.executeAndReturnKey(new
    MapSqlParameterSource(parameters));
    member.setId(key.longValue());
    return member;
    }
  }
  ```

  - 스프링에서 repository 변경
  ``` java
  @Configuration
  public class SpringConfig {
  private final DataSource dataSource;
  public SpringConfig(DataSource dataSource) {
  this.dataSource = dataSource;
  }
  @Bean
  public MemberService memberService() {
  return new MemberService(memberRepository());
  }
  @Bean
  public MemberRepository memberRepository() {
  // return new MemoryMemberRepository();
  // return new JdbcMemberRepository(dataSource);
  return new JdbcTemplateMemberRepository(dataSource);
  }
  }
  ```

3. JPA
  - 기본적인 SQL도 JPA가 직접만들어준다.
  - CRUD, 전체 조회, 카운트 정도?
  - build.gradle 파일에 dependency 추가

  ``` html
    dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    //implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    runtimeOnly 'com.h2database:h2'
    testImplementation('org.springframework.boot:spring-boot-starter-test') {
    exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }
    }
    ```

  - 스프링 부트에 JPA 설정 추가(application.properties)
  ``` html
  spring.jpa.show-sql=true
  spring.jpa.hibernate.ddl-auto=none
  ```
  - none 대신 create를 쓰면 엔티티 바탕으로 테이블도 생성해준다.

  - JPA 엔티티 매핑
  ``` java
  @Entity
  public class Member {
  @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
  private Long id;
  private String name;
  }
  ```
  - @Entity는 엔티티 어노테이션
  - @Id 는 PK 설정
  - @GeneratedValue는 자동생성 index 표시

  - 서비스 계층에 트랜잭션 추가
  ``` java
  import org.springframework.transaction.annotation.Transactional
  @Transactional
  public class MemberService {}
  ```
    - JPA를 통한 모든 데이터 변경은 트랜잭션 안에서 실행


4. 스프링 데이터 JPA
- 스프링 데이터 JPA는 JPA를 손쉽게 사용해주는 기술이다. 독립적인 기술이 아니다.
- 앞의 JPA 설정을 그대로 사용한다.
  ``` java
  public interface SpringDataJpaMemberRepository extends JpaRepository<Member,Long>,MemberRepository {
  Optional<Member> findByName(String name);
  }
  ```
  - 스프링 설정 변경 (빈등록 -> 스프링 주입)
  ``` java
  @Configuration
  public class SpringConfig {
  private final MemberRepository memberRepository;
  public SpringConfig(MemberRepository memberRepository) {
  this.memberRepository = memberRepository;
  }
  @Bean
  public MemberService memberService() {
  return new MemberService(memberRepository);
  }
  }
  ```
  - JpaRepository 상속 인터페이스는 스프링에서 자동으로 구현 클래스를 만들어서 주입한다.

  - JpaRepository 상속관계 구조
  ![](스프링데이터Jpa.png)

  - 스프링 데이터 JPA 제공 기능
    * 인터페이스를 통한 기본적인 CRUD
    * findByName() , findByEmail() 처럼 메서드 이름 만으로 조회 기능 제공
    * 페이징 기능 자동 제공
      - 참고: 실무에서는 JPA와 스프링 데이터 JPA를 기본으로 사용하고, 복잡한 동적 쿼리는 Querydsl이라는 라이브러리를 사용하면 된다. Querydsl을 사용하면 쿼리도 자바 코드로 안전하게 작성할 수 있고, 동적 쿼리도 편리하게 작성할 수 있다. 이 조합으로 해결하기 어려운 쿼리는 JPA가 제공하는 네이티브 쿼리를 사용하거나, 앞서 학습한 스프링 JdbcTemplate를 사용하면 된다.
